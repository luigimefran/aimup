package com.aimup.controller;

import com.aimup.model.Tarefa;
import com.aimup.model.Usuario;
import com.aimup.service.TarefaService;
import com.aimup.service.UsuarioService;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;

import java.security.Principal;
import java.util.List;

@Controller
@RequestMapping("/tarefas")
public class TarefaController {
    private final TarefaService tarefaService;
    private final UsuarioService usuarioService;

    public TarefaController(TarefaService tarefaService, UsuarioService usuarioService) {
        this.tarefaService = tarefaService;
        this.usuarioService = usuarioService;
    }

    @GetMapping("/grupo/{grupoId}")
    public String listar(@PathVariable Long grupoId, Principal principal, Model model) {
        Usuario u = usuarioService.buscarPorEmail(principal.getName());
        List<Tarefa> tarefas = tarefaService.listarAtivasDoGrupoParaUsuario(grupoId, u.getId());
        List<Long> concluidas = tarefaService.idsTarefasConcluidasPorUsuarioNoGrupo(u.getId(), grupoId);
        int pontos = tarefaService.pontosDoUsuarioNoGrupo(u.getId(), grupoId);

        model.addAttribute("tarefas", tarefas);
        model.addAttribute("concluidas", concluidas);
        model.addAttribute("pontos", pontos);
        model.addAttribute("grupoId", grupoId);
        return "grupo/index"; // checklist
    }

    @PostMapping("/{tarefaId}/concluir")
    public String concluir(@PathVariable Long tarefaId,
                           @RequestParam Long grupoId,
                           Principal principal) {
        Usuario u = usuarioService.buscarPorEmail(principal.getName());
        tarefaService.marcarConclusao(tarefaId, u);
        return "redirect:/tarefas/grupo/" + grupoId;
    }
}
