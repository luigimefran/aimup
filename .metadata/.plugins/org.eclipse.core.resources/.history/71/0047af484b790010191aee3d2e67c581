<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AIMUP - Perfil</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/css/styles.css" rel="stylesheet">
  <link rel="shortcut icon" href="/img/LogoAimUp.png" type="image/x-icon">
  <style>
    .profile-pic{width:150px;height:150px;object-fit:cover;border-radius:50%;border:3px solid #198754;}
    body{background-color:#198754;}
    #nomePerfil{margin-top:24px;}
    #imcPerfil{margin-top:6px;}
    .btn-calc{width:auto;}
  </style>
</head>
<body>

  <!-- Flash compacto (estilo do "Voltar") + auto-hide -->
 <div th:if="${mensagemPerfil}"
     id="flashMsg"
     class="btn btn-outline-light btn-sm px-3 rounded position-fixed top-0 start-50 translate-middle-x mt-3 shadow-sm fade show"
     style="z-index:1080; pointer-events:none;"
     th:text="${mensagemPerfil}">
  IMC atualizado!
</div>


  <nav class="navbar navbar-light px-3">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <a th:href="@{/}" class="btn btn-outline-light">Voltar</a>
      <h5 class="mb-0">Perfil</h5>
    </div>
  </nav>

  <div class="container py-5">
    <div class="card text-center p-4">

      <!-- Foto: se usuario/fotoPerfil faltar, usa a logo -->
      <img class="profile-pic mx-auto"
           th:src="${(usuario != null and usuario.fotoPerfil != null and !#strings.isEmpty(usuario.fotoPerfil))} ? ${usuario.fotoPerfil} : '/img/LogoAimUp.png'"
           alt="Perfil">

      <h4 id="nomePerfil">
        <!-- Nome com fallback seguro -->
        <span th:text="${(usuario != null and usuario.nome != null and !#strings.isEmpty(usuario.nome))} ? ${usuario.nome} : 'Usuário'">Usuário</span>
      </h4>

      <p id="imcPerfil" class="mb-2">
        IMC:
        <strong>
          <!-- IMC com fallback e formatação (sem nested ${}) -->
          <span th:text="${(usuario != null and usuario.imc != null)} ? ${#numbers.formatDecimal(usuario.imc,1,2)} : '0.00'">0.00</span>
        </strong>
      </p>

      <div class="mt-3 text-center">
        <a th:href="@{/imc}" class="btn btn-success btn-sm px-3 btn-calc">Calcular IMC</a>
      </div>

      <div class="text-center mt-3">
        <button id="shareBtn" class="btn btn-outline-light btn-sm px-3" type="button">
          <i class="bi bi-share-fill"></i> Compartilhar perfil
        </button>
      </div>
    </div>
  </div>

  <!-- Toast de feedback para "link copiado" -->
  <div class="position-fixed bottom-0 start-50 translate-middle-x mb-3" style="z-index:1055;">
    <div id="copyToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">Link copiado para a área de transferência.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
      (function () {
    const el = document.getElementById('flashMsg');
    if (!el) return;

    // some após 2s com fade suave
    setTimeout(() => {
      el.classList.remove('show'); // ativa o fade (CSS do Bootstrap)
      // depois que a transição acaba (~300ms), remove do fluxo:
      el.addEventListener('transitionend', () => el.remove(), { once: true });
    }, 2000);
  })();

    // Compartilhar: Web Share API (se disponível) OU copiar link
    document.getElementById('shareBtn').addEventListener('click', async () => {
      const link = window.location.href;
      if (navigator.share) {
        try {
          await navigator.share({ title: 'Meu Perfil AIMUP', text: 'Confere meu progresso no AIMUP!', url: link });
        } catch (e) {} // cancelado pelo usuário
      } else {
        try {
          await navigator.clipboard.writeText(link);
          const toastEl = document.getElementById('copyToast');
          const toast = new bootstrap.Toast(toastEl);
          toast.show();
        } catch (e) {
          prompt('Copie o link do seu perfil:', link);
        }
      }
    });
  </script>

</body>
</html>
